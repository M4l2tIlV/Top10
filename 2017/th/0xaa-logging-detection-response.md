# A10:2017 Insufficient Logging and Monitoring

| ผู้โจมตี/ช่องทาง | จุดอ่อนด้านความปลอดภัย           | ผลกระทบ               |
| -- | -- | -- |
| การเข้าถึงช่องโหว่ : ความยากในการโจมตี 2 | แพร่กระจายง่าย 3 : ตรวจพบได้ง่าย 1 | ผลกระทบทางเทคนิค 2 : ผลกระทบทางธุรกิจ |
| ผลกระทบของการเก็บ log และการเฝ้าระวังที่ไม่มีประสิทธิภาพมักจะเป็นปราการด่านสุดท้ายของทุกๆเหตุการณ์ร้ายแรงแทบจะทุกเหตุการณ์. ผู้โจมตีมักอาศัยความไม่พร้อมของการเฝ้าระวังและใช้เวลาในการตอบโต้ที่ยาวนานเพื่อให้สำเร็จตามเป้าหมายที่ต้องการโดยไม่ถูกตรวจจับ. | ปัญหานี้ถูกนำเข้ามาใน Top 10 [industry survey](https://owasp.blogspot.com/2017/08/owasp-top-10-2017-project-update.html). ยุทธวิธีหนึ่งสำหรับการแก้ไข เพื่อให้คุณมีการเฝ้าระวังที่มีประสิทธิภาพ คือการตรวจสอบ logs ตามด้วยการทดสอบเจาะระบบ(penetration testing). การกระทำใดๆของผู้ทดสอบควรถูกบันทึกอย่างดีเพื่อให้เข้าใจถึงผลกระทบที่อาจเกิดขึ้นได้. | การโจมตีที่ประสบผลสำเร็จส่วนใหญ่เริ่มต้นด้วยการทดสอบหาช่องโหว่. การอนุญาตให้กระทำการตรวจสอบดังกล่าวจะนำไปสู่การเพิ่มโอกาสของความสำเร็จในการโจมตีให้ใกล้เคียงถึง 100%. ในปี 2016, พบว่าใช้เวลาถึง [ประมาณ 191 วัน](https://www-01.ibm.com/common/ssi/cgi-bin/ssialias?htmlfid=SEL03130WWEN&) ถึงจะทราบว่าระบบถูกเจาะ – เป็นเวลาที่มากพอที่จะส่งผลรุนแรง. |

## แอพพลิเคชั่นนี้มีช่องโหว่หรือไม่?

ความไม่มีประสิทธิในเรื่องการเก็บ log, การตรวจจับ, การเฝ้าระวัง และ การพร้อมตอบโต้ เกิดขึ้นได้ทุกเมื่อ:

* Audit events ใดๆ, เช่น การเข้าสู่ระบบ, การเข้าสู่ระบบไม่สำเร็จ, และการดำเนินการใดๆที่รุนแรงหรือมีค่ามาก ไม่ได้ถูก log ไว้.
* ไม่มีการสร้าง log Warnings และ errors หรือไม่เพียงพอหรือเป็นข้อความที่ไม่ชัดเจน
* Log ของแอพพลิเคชั่นและ API ใดๆไม่ถูกเฝ้าระวังเพื่อหาพฤติกรรมที่ผิดปกติ.
* Log อยู่เก็บภายในเครื่องเท่านั้น
* ไม่มี/ไม่มีประสิทธิในการกำหนดระดับการแจ้งเตือนอย่างเหมาะสมและแผนการดำเนินการจัดการเหตุที่มีระดับความสำคัญมากขึ้น
* ไม่มีการแจ้งเตือนเมื่อกระทำการทดสอบเจาะระบบและการใช้งานเครื่องมือตรวจสอบหาช่องโหว่([DAST](https://www.owasp.org/index.php/Category:Vulnerability_Scanning_Tools)) (เช่น [OWASP ZAP](https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project) เป็นต้น).
* แอพพลิเคชั่นไม่สามารถตรวจสอบ, เพิ่มระดับความสำคัญ, หรือแจ้งเตือนเมื่อเหตุการณ์โจมตีเกิดขึ้น ในระดับเดียวกับการเกิดเหตุ (real time) หรือใกล้เคียงเวลาการเกิดเหตุ (nearly real time.

หากการเก็บ log และการแจ้งเตือนถูกเห็นโดยผู้ใช้งานทั่วไปหรือผู้โจมตีจะทำให้ระบบเกิดมีช่องโหว่ข้อมูลรั่วไหลได้ (ดูข้อมูลเพิ่มเติมที่ A3:2017-Sensitive Information Exposure).

## ป้องกันอย่างไร

แต่ละความเสี่ยงของการเก็บข้อมูลหรือขั้นตอนของที่กระทำในแต่ละแอพพลิเคชั่น:

* ทำให้แน่ใจว่ารายละเอียดของผู้ใช้งานในการเข้าสู่ระบบใดๆ, การเข้าถึงระบบใดๆที่ล้มเหลว, และการตรวจสอบข้อมูลที่นำเข้าข้อมูลใดๆที่ล้มเหลว ถูกเก็บ log ทั้งหมดนั้นดีพอ เพื่อตรวจสอบหาผู้ใช้งานใดๆที่มีพฤติกรรมผิดปกติหรือทำให้ระบบเกิดความเสียหาย และการควบคุมเวลาให้เพียงพอต่อการกระทำ forensic analysis.
* ทำให้แน่ใจว่า log ทั้งหมดถูกสร้างในรูปแบบที่ง่ายต่อการนำเข้าสู่การเก็บ log แบบรวมศูนย์(centralized log management solutions).
* ทำให้แน่ใจว่าการดำเนินงานใดๆที่สำคัญมีร่องรายให้ตรวจสอบได้ พร้อมกับมีการควบคุมความถูกต้องของข้อมูลเพื่อป้องกันการเปลี่ยนแปลงหรือการลบทิ้ง, เช่น การอนุญาตให้นำข้อมูลเข้าสู่ระบบ table ภายใน database เท่านั้น ไม่สามารถกระทำสิ่งอื่นๆได้ เป็นต้น
* สร้างระบบการเฝ้าระวังและแจ้งเตือนอย่างมีประสิทธิภาพ เช่น เมื่อมีเหตุการณ์ผิดปกติเกิดขึ้นจะต้องตรวจพบได้และสามารถตอบสนองในเวลาที่ใกล้เคียงกับการเกิดขึ้น เป็นต้น
* สร้างหรือนำแผนการตอบสนองเหตุการณ์ที่มีผลกระทบกับระบบ รวมถึงแผนการนำระบบกลับคืนสู่สภาวะปกติ เช่น [NIST 800-61 rev 2](https://csrc.nist.gov/publications/detail/sp/800-61/rev-2/final) เป็นต้น

มีเครื่องมือหรือแอพพลิเคชั่นทางด้านโครงข่ายการป้องกัน ทั้งแบบที่เป็นการค้าขายและ open source เช่น [OWASP AppSensor](https://www.owasp.org/index.php/OWASP_AppSensor_Project), web application firewalls เช่น [ModSecurity with the OWASP ModSecurity Core Rule Set](https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project), และเครื่องมือหาความสัมพันธ์ของ log ด้วย dashboard ที่ปรับแต่งได้และแจ้งเตือนได้.

## ตัวอย่างเหตุการณ์การโจมตี

**เหตุการณ์ที่ #1**: แอพพลิเคชั่น Open Source สำหรับการอภิปราย (An open source project forum software) ถูกใช้งานในทีมเล็กๆทีมหนึ่งถูกแฮ็คผ่านทางช่องโหว่ของอพพลิเคชั่น. ผู้โจมตีกระทำการลบ source code ที่ถูกเก็บไว้ในแหล่งข้อมูลภายใน ซึ่ง source code ดังกล่าวเป็น source code ของแอพพลิเคชั่นรุ่นถัดไป, รวมถึงเนื้อหาภายใน forum นั้นทั้งหมดถูกลบด้วยเช่นกัน. ถึงแม้ว่า source code สามารถที่จะกู้กลับมาได้, แต่เนื่องด้วยขาดการเฝ้าระวัง, การเก็บ log หรือการแจ้งเตือน นำไปสู่การถูกเจาะที่ร้ายแรง. ทำให้ระบบ forum ดังกล่าวถูกระงับการใช้งาน

**เหตุการณ์ที่ #2**: ผู้โจมตีทดสอบหาผู้ใช้งานที่ใช้รหัสผ่านที่เดาได้ง่ายหรือรหัสผ่านทั่วไป. ทำให้ผู้โจมตีสามารถยึด account ของผู้ใช้งานเหล่านั้นโดยใช้รหัสผ่านเหล่านั้นได้. สำหรับผู้ใช้งานอื่นๆ, การทดสอบดังกล่าวทำให้เกิด log การเข้าระบบที่ผิดพลาด. และแน่นอนว่าผู้โจมตีอาจกลับมาโจมตีอีกได้,โดยการเดารหัสผ่านที่แตกต่างไปจากเดิม.

**เหตุการณ์ที่ #3**: มีการรายงานว่าผู้ขายปลีกรายใหญ่ในสหรัญอเมริกาส่วนใหญ่มีระบบสำหรับการตรวจสอบไฟล์ที่ถูกแนบส่งเข้ามา โดยระบบการตรวจสอบดังกล่าวพบแอพพลิเคชั่นประสงค์ร้ายแต่กลับไม่มีผู้ใดตอบสนองกับการแจ้งเตือนนั้น ระบบการตรวจสอบมักมีการแจ้งเตือนก่อนที่การถูกแฮ็คจะเกิดขึ้นเสมอ โดยการถูกแฮ็คมักถูกตรวจพบเมื่อมีการนำบัตรเครดิตไปใช้งานอย่างผิดกฏหมายเรียบร้อยแล้ว

## References

### OWASP

* [OWASP Proactive Controls: Implement Logging and Intrusion Detection](https://www.owasp.org/index.php/OWASP_Proactive_Controls#8:_Implement_Logging_and_Intrusion_Detection)
* [OWASP Application Security Verification Standard: V8 Logging and Monitoring](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP Testing Guide: Testing for Detailed Error Code](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP Cheat Sheet: Logging](https://www.owasp.org/index.php/Logging_Cheat_Sheet)

### External

* [CWE-223: Omission of Security-relevant Information](https://cwe.mitre.org/data/definitions/223.html)
* [CWE-778: Insufficient Logging](https://cwe.mitre.org/data/definitions/778.html)
